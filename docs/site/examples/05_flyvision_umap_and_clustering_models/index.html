
<!doctype html>
<html lang="en" class="no-js">
  <head>

      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">



        <link rel="canonical" href="https://flyvis.github.io/examples/05_flyvision_umap_and_clustering_models/">


        <link rel="prev" href="../04_flyvision_moving_edge_responses/">


        <link rel="next" href="../06_flyvision_maximally_excitatory_stimuli/">


      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.38">



        <title>Ensemble clustering - flyvis docs</title>



      <link rel="stylesheet" href="../../assets/stylesheets/main.8c3ca2c6.min.css">


        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">












        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>



      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">

      <link rel="stylesheet" href="../../style.css">

    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>






  </head>









    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">


    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">


        <a href="#cluster-analysis-based-on-naturalistic-stimuli-responses" class="md-skip">
          Skip to content
        </a>

    </div>
    <div data-md-component="announce">

    </div>







<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="flyvis docs" class="md-header__button md-logo" aria-label="flyvis docs" data-md-component="logo">

  <img src="../../images/flyvis_logo_light@150 ppi.webp" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">

      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            flyvis docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">

              Ensemble clustering

          </span>
        </div>
      </div>
    </div>


        <form class="md-header__option" data-md-component="palette">




    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">

      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>





    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">

      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>





    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">

      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>


</form>



      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>



      <label class="md-header__button md-icon" for="__search">

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">

        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">

          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>

    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>


  </nav>

</header>


    <div class="md-container" data-md-component="container">






      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">



              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="flyvis docs" class="md-nav__button md-logo" aria-label="flyvis docs" data-md-component="logo">

  <img src="../../images/flyvis_logo_light@150 ppi.webp" alt="logo">

    </a>
    flyvis docs
  </label>

  <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">


  <span class="md-ellipsis">
    Home
  </span>


      </a>
    </li>









    <li class="md-nav__item">
      <a href="../../install/" class="md-nav__link">


  <span class="md-ellipsis">
    Installation
  </span>


      </a>
    </li>















    <li class="md-nav__item md-nav__item--active md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>


          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">


  <span class="md-ellipsis">
    Tutorials
  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../01_flyvision_connectome/" class="md-nav__link">


  <span class="md-ellipsis">
    Explore the connectome
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../02_flyvision_optic_flow_task/" class="md-nav__link">


  <span class="md-ellipsis">
    Train the network
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../03_flyvision_flash_responses/" class="md-nav__link">


  <span class="md-ellipsis">
    Flash responses
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../04_flyvision_moving_edge_responses/" class="md-nav__link">


  <span class="md-ellipsis">
    Moving edge responses
  </span>


      </a>
    </li>












    <li class="md-nav__item md-nav__item--active">

      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">





      <a href="./" class="md-nav__link md-nav__link--active">


  <span class="md-ellipsis">
    Ensemble clustering
  </span>


      </a>

    </li>










    <li class="md-nav__item">
      <a href="../06_flyvision_maximally_excitatory_stimuli/" class="md-nav__link">


  <span class="md-ellipsis">
    Maximally excitatory stimuli
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../07_flyvision_providing_custom_stimuli/" class="md-nav__link">


  <span class="md-ellipsis">
    Custom stimuli
  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>













    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >


          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">


  <span class="md-ellipsis">
    Main results
  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Main results
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../figure_01_fly_visual_system/" class="md-nav__link">


  <span class="md-ellipsis">
    Figure 1
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../figure_02_simple_stimuli_responses/" class="md-nav__link">


  <span class="md-ellipsis">
    Figure 2
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../figure_03_naturalistic_stimuli_responses/" class="md-nav__link">


  <span class="md-ellipsis">
    Figure 3
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../figure_04_mechanisms/" class="md-nav__link">


  <span class="md-ellipsis">
    Figure 4
  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>













    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >


          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">


  <span class="md-ellipsis">
    API Reference
  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../../reference/connectome/" class="md-nav__link">


  <span class="md-ellipsis">
    Connectome
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/network/" class="md-nav__link">


  <span class="md-ellipsis">
    Network
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/sintel/" class="md-nav__link">


  <span class="md-ellipsis">
    Sintel
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/tasks/" class="md-nav__link">


  <span class="md-ellipsis">
    Task
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/solver/" class="md-nav__link">


  <span class="md-ellipsis">
    Training
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/flash_responses/" class="md-nav__link">


  <span class="md-ellipsis">
    Flash Responses
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/moving_stimulus_responses/" class="md-nav__link">


  <span class="md-ellipsis">
    Moving Stimulus Responses
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/ensemble_clustering/" class="md-nav__link">


  <span class="md-ellipsis">
    Ensemble Clustering
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/optimal_stimuli/" class="md-nav__link">


  <span class="md-ellipsis">
    Optimal Stimuli
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/scripts/" class="md-nav__link">


  <span class="md-ellipsis">
    Scripts
  </span>


      </a>
    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_11" >


          <label class="md-nav__link" for="__nav_5_11" id="__nav_5_11_label" tabindex="0">


  <span class="md-ellipsis">
    Miscelleanous
  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_11">
            <span class="md-nav__icon md-icon"></span>
            Miscelleanous
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../../reference/rendering/" class="md-nav__link">


  <span class="md-ellipsis">
    Rendering
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/augmentation/" class="md-nav__link">


  <span class="md-ellipsis">
    Augmentation
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/datasets/" class="md-nav__link">


  <span class="md-ellipsis">
    Datasets
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/utils/" class="md-nav__link">


  <span class="md-ellipsis">
    Utils
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/visualizations/" class="md-nav__link">


  <span class="md-ellipsis">
    Visualizations
  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../reference/animations/" class="md-nav__link">


  <span class="md-ellipsis">
    Animations
  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>




          </ul>
        </nav>

    </li>









    <li class="md-nav__item">
      <a href="../../contribute/" class="md-nav__link">


  <span class="md-ellipsis">
    Contributing
  </span>


      </a>
    </li>









    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">


  <span class="md-ellipsis">
    FAQ
  </span>


      </a>
    </li>









    <li class="md-nav__item">
      <a href="../../acknowledgements/" class="md-nav__link">


  <span class="md-ellipsis">
    Acknowledgements
  </span>


      </a>
    </li>



  </ul>
</nav>
                  </div>
                </div>
              </div>



              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">






</nav>
                  </div>
                </div>
              </div>



            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">




<pre><code class="language-python">%load_ext autoreload
%autoreload 2
</code></pre>
<h1 id="cluster-analysis-based-on-naturalistic-stimuli-responses">Cluster analysis based on naturalistic stimuli responses</h1>
<p>This notebook illustrates how to cluster the models of an ensemble after nonlinear dimensionality reduction on their predicted responses to naturalistic stimuli. This can be done for any cell type. Here we provide a detailed example focusing on clustering based on T4c responses.</p>
<p><strong>Select GPU runtime</strong></p>
<p>To run the notebook on a GPU select Menu -&gt; Runtime -&gt; Change runtime type -&gt; GPU.</p>
<pre><code class="language-python"># @markdown **Check access to GPU**

try:
    import google.colab

    IN_COLAB = True
except ImportError:
    IN_COLAB = False

if IN_COLAB:
    import torch

    try:
        cuda_name = torch.cuda.get_device_name()
        print(f&quot;Name of the assigned GPU / CUDA device: {cuda_name}&quot;)
    except RuntimeError:
        import warnings

        warnings.warn(
            &quot;You have not selected Runtime Type: 'GPU' or Google could not assign you one. Please revisit the settings as described above or proceed on CPU (slow).&quot;
        )
</code></pre>
<p><strong>Install Flyvis</strong></p>
<p>The notebook requires installing our package <code>flyvis</code>. You may need to restart your session after running the code block below with Menu -&gt; Runtime -&gt; Restart session. Then, imports from <code>flyvis</code> should succeed without issue.</p>
<pre><code class="language-python">if IN_COLAB:
    # @markdown **Install Flyvis**
    %%capture
    !git clone https://github.com/flyvis/flyvis-dev.git
    %cd /content/flyvis-dev
    !pip install -e .
</code></pre>
<pre><code class="language-python"># basic imports
import matplotlib.pyplot as plt
import numpy as np
import torch

plt.rcParams['figure.dpi'] = 200
</code></pre>
<h1 id="naturalistic-stimuli-dataset-sintel">Naturalistic stimuli dataset (Sintel)</h1>
<p>We load the dataset with our custom augmentations. The dataset contains movie sequences from the publicly available computer-animated movie Sintel rendered to the hexagonal lattice structure of the fly eye. For a more detailed introduction to the dataset class and parameters see the notebook on the optic flow task.</p>
<pre><code class="language-python">import flyvision
from flyvision.datasets.sintel import AugmentedSintel
from flyvision.analysis.animations import HexScatter
import numpy as np
</code></pre>
<pre><code class="language-python">dt = 1 / 100  # can be changed for other temporal resolutions
dataset = AugmentedSintel(
    tasks=[&quot;lum&quot;],
    interpolate=False,
    boxfilter={'extent': 15, 'kernel_size': 13},
    temporal_split=True,
    dt=dt,
)
</code></pre>
<pre><code class="language-python"># view stimulus parameters
dataset.arg_df
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>original_index</th>
      <th>vertical_split_index</th>
      <th>temporal_split_index</th>
      <th>frames</th>
      <th>flip_ax</th>
      <th>n_rot</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>sequence_00_alley_1_split_00</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>19</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>sequence_00_alley_1_split_00</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>19</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>sequence_00_alley_1_split_00</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>19</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>sequence_00_alley_1_split_00</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>19</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>sequence_00_alley_1_split_00</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>19</td>
      <td>0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2263</th>
      <td>sequence_22_temple_3_split_02</td>
      <td>22</td>
      <td>68</td>
      <td>188</td>
      <td>19</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2264</th>
      <td>sequence_22_temple_3_split_02</td>
      <td>22</td>
      <td>68</td>
      <td>188</td>
      <td>19</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2265</th>
      <td>sequence_22_temple_3_split_02</td>
      <td>22</td>
      <td>68</td>
      <td>188</td>
      <td>19</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2266</th>
      <td>sequence_22_temple_3_split_02</td>
      <td>22</td>
      <td>68</td>
      <td>188</td>
      <td>19</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2267</th>
      <td>sequence_22_temple_3_split_02</td>
      <td>22</td>
      <td>68</td>
      <td>188</td>
      <td>19</td>
      <td>1</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
<p>2268 rows Ã— 7 columns</p>
</div>

<pre><code class="language-python">sequence = dataset[0][&quot;lum&quot;]
</code></pre>
<pre><code class="language-python"># one sequence contains 80 frames with 721 hexals each
sequence.shape
</code></pre>
<pre><code>torch.Size([80, 1, 721])
</code></pre>
<pre><code class="language-python">animation = HexScatter(sequence[None], vmin=0, vmax=1)
animation.animate_in_notebook(frames=np.arange(5))
</code></pre>
<p><img alt="png" src="../05_flyvision_umap_and_clustering_models_files/05_flyvision_umap_and_clustering_models_13_0.png" /></p>
<h1 id="ensemble-responses-to-naturalistic-sequences">Ensemble responses to naturalistic sequences</h1>
<p>We compute the responses of all models in the stored ensemble to the augmented Sintel dataset.</p>
<pre><code class="language-python">from flyvision import results_dir
</code></pre>
<pre><code class="language-python"># We load the ensemble trained on the optic flow task
ensemble = flyvision.EnsembleView(results_dir / &quot;flow/0000&quot;)
</code></pre>
<pre><code>Loading ensemble:   0%|          | 0/50 [00:00&lt;?, ?it/s]


[2024-10-04 22:47:37] ensemble:142 Loaded 50 networks.
</code></pre>
<p>We use <code>ensemble.naturalistic_stimuli_responses</code> to return responses of all networks within the ensemble.</p>
<pre><code class="language-python">stims_and_resps = ensemble.naturalistic_stimuli_responses()
</code></pre>
<pre><code class="language-python">norm = ensemble.responses_norm()
</code></pre>
<pre><code class="language-python">responses = stims_and_resps[&quot;responses&quot;] / (norm + 1e-6)
</code></pre>
<pre><code class="language-python">responses.custom.where(cell_type=&quot;T4c&quot;, u=0, v=0, sample=0).custom.plot_traces(
    x=&quot;time&quot;, plot_kwargs=dict(color=&quot;tab:blue&quot;, add_legend=False)
)
ax = plt.gca()
ax.set_title(&quot;T4c responses to naturalistic stimuli&quot;)
</code></pre>
<pre><code>Text(0.5, 1.0, 'T4c responses to naturalistic stimuli')
</code></pre>
<p><img alt="png" src="../05_flyvision_umap_and_clustering_models_files/05_flyvision_umap_and_clustering_models_21_1.png" /></p>
<p>We see that the across models of the ensemble the predictions for T4c vary. Our goal is to understand the underlying structure in those variations.</p>
<h2 id="nonlinear-dimensionality-reduction-umap-and-gaussian-mixtures">Nonlinear dimensionality reduction (UMAP) and Gaussian Mixtures</h2>
<pre><code class="language-python">from flyvision.analysis.clustering import EnsembleEmbedding, get_cluster_to_indices
from flyvision.utils.activity_utils import CentralActivity
</code></pre>
<pre><code class="language-python"># specify parameters for umap embedding

embedding_kwargs = {
    &quot;min_dist&quot;: 0.105,
    &quot;spread&quot;: 9.0,
    &quot;n_neighbors&quot;: 5,
    &quot;random_state&quot;: 42,
    &quot;n_epochs&quot;: 1500,
}
</code></pre>
<p>We compute the UMAP embedding of the ensemble based on the T4c responses of the single models to the single sequence for illustration.</p>
<pre><code class="language-python">central_responses = CentralActivity(responses.values, connectome=ensemble.connectome)
</code></pre>
<pre><code class="language-python">embedding = EnsembleEmbedding(central_responses)
t4c_embedding = embedding(&quot;T4c&quot;, embedding_kwargs=embedding_kwargs)
</code></pre>
<pre><code>[2024-10-04 22:47:52] clustering:349 reshaped X from (50, 2268, 80) to (50, 181440)
/home/lappalainenj@hhmi.org/miniconda3/envs/flyvision/lib/python3.9/site-packages/umap/umap_.py:1356: RuntimeWarning: divide by zero encountered in power
  return 1.0 / (1.0 + a * x ** (2 * b))
</code></pre>
<pre><code class="language-python">task_error = ensemble.task_error()
</code></pre>
<pre><code class="language-python">embeddingplot = t4c_embedding.plot(colors=task_error.colors)
</code></pre>
<p><img alt="png" src="../05_flyvision_umap_and_clustering_models_files/05_flyvision_umap_and_clustering_models_30_0.png" /></p>
<p>Each of these scatterpoints in 2d represents a single time series plotted above.</p>
<p>We fit a Gaussian Mixture of 2 to 5 components to this embedding to label the clusters. We select the final number of Gaussian Mixture components that minimize the Bayesian Information Criterion (BIC).</p>
<pre><code class="language-python"># specifiy parameters for Gaussian Mixture

gm_kwargs = {
    &quot;range_n_clusters&quot;: [1, 2, 3, 4, 5],
    &quot;n_init&quot;: 100,
    &quot;max_iter&quot;: 1000,
    &quot;random_state&quot;: 42,
    &quot;tol&quot;: 0.001,
}
</code></pre>
<pre><code class="language-python">gm_clustering = t4c_embedding.cluster.gaussian_mixture(**gm_kwargs)
</code></pre>
<pre><code class="language-python">embeddingplot = gm_clustering.plot(task_error=task_error.values, colors=task_error.colors)
</code></pre>
<p><img alt="png" src="../05_flyvision_umap_and_clustering_models_files/05_flyvision_umap_and_clustering_models_34_0.png" /></p>
<p>We can use the labels to disambiguate the time series data that we plotted above. We expect that these labels aggregate similar time series together and different time series separately.</p>
<pre><code class="language-python">import matplotlib.colors as mcolors
</code></pre>
<pre><code class="language-python">cluster_to_indices = get_cluster_to_indices(
    embeddingplot.cluster.embedding.mask,
    embeddingplot.cluster.labels,
    ensemble.task_error(),
)
</code></pre>
<pre><code class="language-python">fig, axes = plt.subplots(1, len(cluster_to_indices), figsize=(6, 2))
colors = {i: color for i, color in enumerate(mcolors.TABLEAU_COLORS.values())}
for cluster_id, indices in cluster_to_indices.items():
    responses.sel(network_id=indices, sample=[0]).custom.where(
        cell_type=&quot;T4c&quot;
    ).custom.plot_traces(
        x=&quot;time&quot;,
        plot_kwargs=dict(color=colors[cluster_id], add_legend=False, ax=axes[cluster_id]),
    )
    axes[cluster_id].set_title(f&quot;Cluster {cluster_id + 1}&quot;)
plt.subplots_adjust(wspace=0.3)
</code></pre>
<p><img alt="png" src="../05_flyvision_umap_and_clustering_models_files/05_flyvision_umap_and_clustering_models_38_0.png" /></p>
<p>The clustering has led us to three qualitatively distinct predictions from the ensemble for this cell and sequence. This is a first lead for an underlying structure in these predictions. We will get an even better estimate once we use more sequences for the clustering.</p>
<h1 id="using-the-clustering-to-discover-tuning-predictions-in-responses-to-simple-stimuli">Using the clustering to discover tuning predictions in responses to simple stimuli</h1>
<p>We expect that the clustering based on naturalistic stimuli will also disambiguate the different tuning predictions from different models for simple stimuli.</p>
<pre><code class="language-python">cluster_to_indices = get_cluster_to_indices(
    embeddingplot.cluster.embedding.mask,
    embeddingplot.cluster.labels,
    ensemble.task_error(),
)
</code></pre>
<pre><code class="language-python"># define different colormaps for clusters
cluster_colors = {}
CMAPS = [&quot;Blues_r&quot;, &quot;Reds_r&quot;, &quot;Greens_r&quot;, &quot;Oranges_r&quot;, &quot;Purples_r&quot;]

for cluster_id in cluster_to_indices:
    cluster_colors[cluster_id] = ensemble.task_error(cmap=CMAPS[cluster_id]).colors
</code></pre>
<h2 id="clustered-voltage-responses-to-moving-edges">Clustered voltage responses to moving edges</h2>
<pre><code class="language-python">from flyvision.analysis.moving_bar_responses import plot_angular_tuning
from flyvision.analysis.visualization import plt_utils
from flyvision.utils.color_utils import color_to_cmap
</code></pre>
<pre><code class="language-python">stims_and_resps_moving_edge = ensemble.moving_edge_responses()
</code></pre>
<pre><code class="language-python"># invariant to different magnitudes of responses, only to assess direction tuning
stims_and_resps_moving_edge[&quot;responses&quot;] /= np.abs(
    stims_and_resps_moving_edge[&quot;responses&quot;]
).max(dim=(&quot;sample&quot;, &quot;frame&quot;))

# relative to the norm of the responses to naturalistic stimuli (used for averaging)
# stims_and_resps_moving_edge['responses'] /= (norm + 1e-6)
</code></pre>
<pre><code class="language-python">fig, axes = plt.subplots(1, len(cluster_to_indices), figsize=(6, 2))
colors = {i: color for i, color in enumerate(mcolors.TABLEAU_COLORS.values())}
for cluster_id, indices in cluster_to_indices.items():
    stims_and_resps_moving_edge['responses'].sel(network_id=indices).custom.where(
        cell_type=&quot;T4c&quot;, intensity=1, speed=19, angle=90
    ).custom.plot_traces(
        x=&quot;time&quot;,
        plot_kwargs=dict(color=colors[cluster_id], add_legend=False, ax=axes[cluster_id]),
    )
    axes[cluster_id].set_title(f&quot;Cluster {cluster_id + 1}&quot;)
plt.subplots_adjust(wspace=0.3)
</code></pre>
<p><img alt="png" src="../05_flyvision_umap_and_clustering_models_files/05_flyvision_umap_and_clustering_models_48_0.png" /></p>
<pre><code class="language-python">plot_angular_tuning(
    stims_and_resps_moving_edge,
    &quot;T4c&quot;,
    intensity=1,
)
</code></pre>
<pre><code>(&lt;Figure size 300x300 with 1 Axes&gt;, &lt;PolarAxes: &gt;)
</code></pre>
<p><img alt="png" src="../05_flyvision_umap_and_clustering_models_files/05_flyvision_umap_and_clustering_models_49_1.png" /></p>
<pre><code class="language-python">tabcolors = list(mcolors.TABLEAU_COLORS.values())
colors = [
    ensemble.task_error(cmap=color_to_cmap(tabcolors[cluster_id]).reversed()).colors[
        indices
    ]
    for cluster_id, indices in cluster_to_indices.items()
]
fig, axes = plt.subplots(
    1, len(cluster_to_indices), subplot_kw={&quot;projection&quot;: &quot;polar&quot;}, figsize=[2, 1]
)
for cluster_id, indices in cluster_to_indices.items():
    plot_angular_tuning(
        stims_and_resps_moving_edge.sel(network_id=indices),
        &quot;T4c&quot;,
        intensity=1,
        colors=colors[cluster_id],
        zorder=ensemble.zorder()[indices],
        groundtruth=True if cluster_id == 0 else False,
        fig=fig,
        ax=axes[cluster_id],
    )
    plt_utils.add_cluster_marker(
        fig, axes[cluster_id], marker=plt_utils.get_marker(cluster_id)
    )
    axes[cluster_id].set_title(f&quot;Cluster {cluster_id + 1}&quot;)
plt.subplots_adjust(wspace=0.5)
</code></pre>
<p><img alt="png" src="../05_flyvision_umap_and_clustering_models_files/05_flyvision_umap_and_clustering_models_50_0.png" /></p>
<p>As we can see here, the models predict clustered neural responses.</p>
<h1 id="load-precomputed-umap-and-clustering">Load precomputed umap and clustering</h1>
<p>Due to the computational requirement of recording and embedding all responses and for consistency we also show how to use the precomputed embeddings and clusterings from the paper.</p>
<pre><code class="language-python">cell_type = &quot;T4c&quot;
clustering = ensemble.clustering(cell_type)
</code></pre>
<pre><code>[2024-10-04 22:49:49] clustering:643 Loaded T4c embedding and clustering from /groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/umap_and_clustering.
</code></pre>
<pre><code class="language-python">task_error = ensemble.task_error()
</code></pre>
<pre><code class="language-python">embeddingplot = clustering.plot(task_error=task_error.values, colors=task_error.colors)
</code></pre>
<p><img alt="png" src="../05_flyvision_umap_and_clustering_models_files/05_flyvision_umap_and_clustering_models_56_0.png" /></p>
<p>With this embedding and clustering one can proceed in the same way as above to plot the tunings.</p>













              </article>
            </div>


<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>

      </main>

        <footer class="md-footer">

  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">


    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>

</div>

    </div>
  </div>
</footer>

    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>


    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>


      <script src="../../assets/javascripts/bundle.d6f25eb3.min.js"></script>

        <script src="../../javascripts/switch-logo.js"></script>


  </body>
</html>
